---
# Ansible Playbook: Setup Kickstart Server for Power LPARs
#
# Uses role setup_rhel_pxe_structure for ISO/repo/TFTP layout, then configures
# dnsmasq, httpd, firewall and services.
#
# Usage:
#   ansible-playbook setup_kickstart_server.yml -i inventory/hosts.yml \
#     -e "rhel_version=9.6" \
#     -e "iso_path=/path/to/rhel-9.6-ppc64le.iso"
#
# Variables: group_vars/kickstart_servers.yml or extra-vars

- name: Setup Kickstart Server for Power LPARs
  hosts: kickstart_servers
  become: true
  gather_facts: true

  vars:
    rhel_version: "9.6"
    rhel_major_version: "{{ rhel_version.split('.')[0] }}"
    iso_path: "/root/rhel-{{ rhel_version }}-ppc64le-dvd.iso"
    kickstart_base_dir: "/var/www/html/kickstart"
    tftp_root: "/var/lib/tftpboot"
    iso_mount_point: "/mnt/rhel-iso"
    repo_dir: "{{ kickstart_base_dir }}/rhel{{ rhel_major_version }}"
    dhcp_domain_name: "{{ domain_name | default('localdomain') }}"
    kickstart_server_ip: "{{ ansible_default_ipv4.address }}"
    upstream_dns_servers:
      - "{{ dns_server1 | default('8.8.8.8') }}"
      - "{{ dns_server2 | default('8.8.4.4') }}"
    dns_cache_size: 1000
    ks_root_password: "{{ root_password | default('changeme') }}"
    ks_timezone: "{{ timezone | default('Europe/Berlin') }}"
    ks_keyboard: "{{ keyboard_layout | default('us') }}"
    ks_language: "{{ language | default('en_US.UTF-8') }}"
    firewall_services:
      - dns
      - tftp
      - http
      - https
    firewall_ports:
      - 53/tcp
      - 53/udp
      - 69/udp
      - 80/tcp
      - 443/tcp
      - 67/udp
      - 68/udp
      - 4011/udp

  pre_tasks:
    - name: Validate system architecture is ppc64le
      ansible.builtin.assert:
        that:
          - ansible_architecture == "ppc64le"
        fail_msg: "This playbook is for Power (ppc64le). Current: {{ ansible_architecture }}"

    - name: Check if ISO file exists
      ansible.builtin.stat:
        path: "{{ iso_path }}"
      register: iso_stat

    - name: Warn if ISO not found
      ansible.builtin.debug:
        msg: |
          WARNING: ISO not found at {{ iso_path }}
          Upload the RHEL ISO and re-run, or run with -e require_iso=false.
      when: not iso_stat.stat.exists

  roles:
    - role: setup_rhel_pxe_structure
      setup_rhel_pxe_structure_iso_path: "{{ iso_path }}"
      setup_rhel_pxe_structure_rhel_version: "{{ rhel_version }}"
      setup_rhel_pxe_structure_kickstart_base_dir: "{{ kickstart_base_dir }}"
      setup_rhel_pxe_structure_tftp_root: "{{ tftp_root }}"
      setup_rhel_pxe_structure_iso_mount_point: "{{ iso_mount_point }}"
      setup_rhel_pxe_structure_require_iso: false

  tasks:
    - name: Stop and disable conflicting services
      ansible.builtin.service:
        name: "{{ item }}"
        state: stopped
        enabled: false
      loop:
        - systemd-resolved
      ignore_errors: true

    - name: Backup original dnsmasq configuration
      ansible.builtin.copy:
        src: /etc/dnsmasq.conf
        dest: /etc/dnsmasq.conf.original
        remote_src: true
        force: false
      ignore_errors: true

    - name: Configure dnsmasq for DNS caching and PXE proxy
      ansible.builtin.template:
        src: templates/dnsmasq.conf.j2
        dest: /etc/dnsmasq.conf
        mode: "0644"
        backup: true
        validate: "dnsmasq --test -C %s"
      notify: Restart dnsmasq

    - name: Create dnsmasq TFTP directory
      ansible.builtin.file:
        path: "{{ tftp_root }}"
        state: directory
        mode: "0755"
        owner: dnsmasq
        group: dnsmasq

    - name: Ensure dnsmasq can read TFTP files
      ansible.builtin.file:
        path: "{{ tftp_root }}"
        state: directory
        recurse: true
        mode: "0755"

    - name: Configure Apache for kickstart
      ansible.builtin.template:
        src: templates/kickstart.conf.j2
        dest: /etc/httpd/conf.d/kickstart.conf
        mode: "0644"
      notify: Restart httpd

    - name: Create default kickstart file for Power LPARs
      ansible.builtin.template:
        src: templates/ks-power.cfg.j2
        dest: "{{ kickstart_base_dir }}/ks/ks-rhel{{ rhel_major_version }}-power.cfg"
        mode: "0644"

    - name: Create GRUB2 configuration for Power network boot
      ansible.builtin.template:
        src: templates/grub.cfg.j2
        dest: "{{ tftp_root }}/grub2-ppc64le/grub.cfg"
        mode: "0644"

    - name: Ensure firewalld is running
      ansible.builtin.service:
        name: firewalld
        state: started
        enabled: true

    - name: Configure firewall services
      ansible.posix.firewalld:
        service: "{{ item }}"
        permanent: true
        state: enabled
        immediate: true
      loop: "{{ firewall_services }}"
      ignore_errors: true

    - name: Configure firewall ports
      ansible.posix.firewalld:
        port: "{{ item }}"
        permanent: true
        state: enabled
        immediate: true
      loop: "{{ firewall_ports }}"

    - name: Set SELinux context for TFTP directory
      community.general.sefcontext:
        target: "{{ tftp_root }}(/.*)?"
        setype: tftpdir_t
        state: present
      notify: Restore SELinux contexts
      ignore_errors: true

    - name: Set SELinux context for HTTP directory
      community.general.sefcontext:
        target: "{{ kickstart_base_dir }}(/.*)?"
        setype: httpd_sys_content_t
        state: present
      notify: Restore SELinux contexts
      ignore_errors: true

    - name: Enable SELinux boolean for TFTP home directories
      ansible.posix.seboolean:
        name: tftp_home_dir
        state: true
        persistent: true
      ignore_errors: true

    - name: Enable and start services
      ansible.builtin.service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - dnsmasq
        - httpd

    - name: Display kickstart server configuration summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          KICKSTART SERVER CONFIGURATION COMPLETE
          ============================================================
          Server IP: {{ kickstart_server_ip }}
          TFTP Root: {{ tftp_root }}
          Kickstart: {{ kickstart_base_dir }}/ks/
          RHEL Repo: {{ repo_dir }}
          Boot file: grub2-ppc64le/core.elf
          ============================================================

  handlers:
    - name: Restart dnsmasq
      ansible.builtin.service:
        name: dnsmasq
        state: restarted

    - name: Restart httpd
      ansible.builtin.service:
        name: httpd
        state: restarted

    - name: Restore SELinux contexts
      ansible.builtin.command:
        cmd: "restorecon -Rv {{ tftp_root }} {{ kickstart_base_dir }}"
      changed_when: true
