---
# yamllint disable rule:quoted-strings
# =============================================================================
# CREATE LPAR LOGICAL VOLUME ON VIOS (Standalone Role)
# =============================================================================
# Erstellt vSCSI-Adapter (LPAR <-> VIOS), Logical Volume auf VIOS und
# mappt das LV an die LPAR.
# =============================================================================

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - create_lpar_lv_lpar_name is defined and create_lpar_lv_lpar_name | length > 0
      - create_lpar_lv_managed_system is defined and create_lpar_lv_managed_system | length > 0
      - create_lpar_lv_volume_name is defined and create_lpar_lv_volume_name | length > 0
      - create_lpar_lv_volume_group is defined and create_lpar_lv_volume_group | length > 0
      - create_lpar_lv_vios_name is defined and create_lpar_lv_vios_name | length > 0
      - create_lpar_lv_hmc_password is defined and create_lpar_lv_hmc_password | length > 0
      - create_lpar_lv_vios_password is defined and create_lpar_lv_vios_password | length > 0
    fail_msg: |
      Fehlende Pflichtvariablen. Bitte setzen:
        create_lpar_lv_lpar_name, create_lpar_lv_managed_system,
        create_lpar_lv_volume_name, create_lpar_lv_volume_group,
        create_lpar_lv_vios_name, create_lpar_lv_hmc_password, create_lpar_lv_vios_password

# =============================================================================
# LPAR-Facts vom HMC holen (für PartitionID)
# =============================================================================

- name: Get LPAR facts from HMC
  ibm.power_hmc.powervm_lpar_instance:
    hmc_host: "{{ create_lpar_lv_hmc_host }}"
    hmc_auth: "{{ create_lpar_lv_hmc_auth }}"
    system_name: "{{ create_lpar_lv_managed_system }}"
    vm_name: "{{ create_lpar_lv_lpar_name }}"
    advanced_info: true
    state: facts
  register: create_lpar_lv_facts_output

- name: Fail if LPAR not found or facts missing
  ansible.builtin.fail:
    msg: "LPAR '{{ create_lpar_lv_lpar_name }}' not found or partition_info missing on {{ create_lpar_lv_managed_system }}."
  when: create_lpar_lv_facts_output.partition_info is not defined

- name: Set partition ID in hex format
  ansible.builtin.set_fact:
    create_lpar_lv_partition_id_hex: "{{ ('0x%08x' | format(create_lpar_lv_facts_output.partition_info.PartitionID | default(0) | int)) }}"
  when: create_lpar_lv_facts_output.partition_info is defined

# =============================================================================
# Virtual SCSI Slots
# =============================================================================

- name: Set vSCSI client slot for LPAR
  ansible.builtin.set_fact:
    create_lpar_lv_lpar_scsi_slot: "{{ create_lpar_lv_vscsi_client_slot }}"

- name: Set vSCSI server slot on VIOS (default partition_id + 10)
  ansible.builtin.set_fact:
    create_lpar_lv_vios_scsi_slot: "{{ create_lpar_lv_vscsi_server_slot | default((create_lpar_lv_facts_output.partition_info.PartitionID | int) + 10) }}"

# =============================================================================
# VIOS Partition ID und LPAR-Profilname vom HMC
# =============================================================================

- name: Get VIOS partition ID from HMC  # noqa: command-instead-of-shell
  ansible.builtin.shell: >-
    sshpass -p '{{ create_lpar_lv_hmc_password }}'
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
    {{ create_lpar_lv_hmc_username }}@{{ create_lpar_lv_hmc_host }}
    "lssyscfg -r lpar -m {{ create_lpar_lv_managed_system }}
    -F lpar_id --filter lpar_names={{ create_lpar_lv_vios_name }}"
  register: create_lpar_lv_vios_id_result
  changed_when: false

- name: Set VIOS partition ID fact
  ansible.builtin.set_fact:
    create_lpar_lv_vios_id: "{{ create_lpar_lv_vios_id_result.stdout | trim }}"

- name: Get LPAR profile name from HMC  # noqa: command-instead-of-shell
  ansible.builtin.shell: >-
    sshpass -p '{{ create_lpar_lv_hmc_password }}'
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
    {{ create_lpar_lv_hmc_username }}@{{ create_lpar_lv_hmc_host }}
    "lssyscfg -r prof -m {{ create_lpar_lv_managed_system }}
    --filter lpar_names={{ create_lpar_lv_lpar_name }} -F name"
  register: create_lpar_lv_profile_result
  changed_when: false

- name: Set LPAR profile name fact
  ansible.builtin.set_fact:
    create_lpar_lv_profile_name: "{{ create_lpar_lv_profile_result.stdout | trim }}"

# =============================================================================
# Virtual SCSI Server-Adapter auf VIOS anlegen (DLPAR)
# =============================================================================

- name: Add virtual SCSI server adapter to VIOS via HMC  # noqa: command-instead-of-shell
  ansible.builtin.shell: >-
    sshpass -p '{{ create_lpar_lv_hmc_password }}'
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
    {{ create_lpar_lv_hmc_username }}@{{ create_lpar_lv_hmc_host }}
    "chhwres -r virtualio --rsubtype scsi -m {{ create_lpar_lv_managed_system }}
    -o a -p {{ create_lpar_lv_vios_name }}
    -s {{ create_lpar_lv_vios_scsi_slot }}
    -a 'adapter_type=server,remote_lpar_name={{ create_lpar_lv_lpar_name }},remote_slot_num={{ create_lpar_lv_lpar_scsi_slot }}'"
  register: create_lpar_lv_add_scsi_server_result
  failed_when: >-
    create_lpar_lv_add_scsi_server_result.rc != 0 and
    'already exists' not in create_lpar_lv_add_scsi_server_result.stdout
  changed_when: create_lpar_lv_add_scsi_server_result.rc == 0

# =============================================================================
# Virtual SCSI Client-Adapter am LPAR-Profil anlegen
# =============================================================================

- name: Build chsyscfg -i parameter for vSCSI client
  ansible.builtin.set_fact:
    _create_lpar_lv_chsyscfg_i: "name={{ create_lpar_lv_profile_name }},lpar_name={{ create_lpar_lv_lpar_name }},virtual_scsi_adapters+={{ create_lpar_lv_lpar_scsi_slot }}/client/{{ create_lpar_lv_vios_id }}/{{ create_lpar_lv_vios_name }}/{{ create_lpar_lv_vios_scsi_slot }}/0"

- name: Add virtual SCSI client adapter to LPAR profile via HMC  # noqa: command-instead-of-shell
  ansible.builtin.shell: >-
    sshpass -p '{{ create_lpar_lv_hmc_password }}'
    ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
    {{ create_lpar_lv_hmc_username }}@{{ create_lpar_lv_hmc_host }}
    "chsyscfg -r prof -m {{ create_lpar_lv_managed_system }} --force -i '{{ _create_lpar_lv_chsyscfg_i }}'"
  register: create_lpar_lv_add_scsi_client_result
  failed_when: >-
    create_lpar_lv_add_scsi_client_result.rc != 0 and
    'virtual adapter has been specified' not in create_lpar_lv_add_scsi_client_result.stdout
  changed_when: create_lpar_lv_add_scsi_client_result.rc == 0

- name: Wait for VIOS to recognize new virtual adapter
  ansible.builtin.pause:
    seconds: 5

# =============================================================================
# Neuen virtuellen Adapter auf VIOS konfigurieren (vhost)
# =============================================================================

- name: Configure new virtual adapter on VIOS (creates vhost device)
  ansible.builtin.raw: ioscli cfgdev -dev vio0
  delegate_to: "{{ create_lpar_lv_vios_host }}"
  remote_user: "{{ create_lpar_lv_vios_user }}"
  vars:
    ansible_connection: ssh
    ansible_ssh_pass: "{{ create_lpar_lv_vios_password }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  register: create_lpar_lv_cfgdev_result
  changed_when: create_lpar_lv_cfgdev_result.rc == 0
  failed_when: false

- name: Refresh LPAR facts after adding vSCSI adapter
  ibm.power_hmc.powervm_lpar_instance:
    hmc_host: "{{ create_lpar_lv_hmc_host }}"
    hmc_auth: "{{ create_lpar_lv_hmc_auth }}"
    system_name: "{{ create_lpar_lv_managed_system }}"
    vm_name: "{{ create_lpar_lv_lpar_name }}"
    advanced_info: true
    state: facts
  register: create_lpar_lv_facts_output

# Partition-ID-Hex ist unverändert
- name: Re-set partition ID hex after refresh
  ansible.builtin.set_fact:
    create_lpar_lv_partition_id_hex: "{{ ('0x%08x' | format(create_lpar_lv_facts_output.partition_info.PartitionID | default(0) | int)) }}"
  when: create_lpar_lv_facts_output.partition_info is defined

# =============================================================================
# Logical Volume auf VIOS anlegen
# =============================================================================

- name: Create logical volume on VIOS
  ansible.builtin.raw: >-
    ioscli mklv -lv {{ create_lpar_lv_volume_name }}
    {{ create_lpar_lv_volume_group }} {{ create_lpar_lv_disk_size_gb }}G
  delegate_to: "{{ create_lpar_lv_vios_host }}"
  remote_user: "{{ create_lpar_lv_vios_user }}"
  vars:
    ansible_connection: ssh
    ansible_ssh_pass: "{{ create_lpar_lv_vios_password }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  register: create_lpar_lv_mklv_result
  failed_when: >-
    create_lpar_lv_mklv_result.rc != 0 and
    'already exists' not in create_lpar_lv_mklv_result.stdout
  changed_when: create_lpar_lv_mklv_result.rc == 0

# =============================================================================
# vhost-Adapter für diese LPAR finden (über Partition-ID)
# =============================================================================

- name: Get all vhost mappings from VIOS
  ansible.builtin.raw: ioscli lsmap -all -fmt ':'
  delegate_to: "{{ create_lpar_lv_vios_host }}"
  remote_user: "{{ create_lpar_lv_vios_user }}"
  vars:
    ansible_connection: ssh
    ansible_ssh_pass: "{{ create_lpar_lv_vios_password }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  register: create_lpar_lv_lsmap_all_result
  changed_when: false

- name: Extract vhost adapter line for this LPAR by partition ID
  ansible.builtin.set_fact:
    create_lpar_lv_vhost_line: >-
      {{ create_lpar_lv_lsmap_all_result.stdout_lines |
         select('search', create_lpar_lv_partition_id_hex) |
         first | default('') }}

- name: Set vhost adapter name
  ansible.builtin.set_fact:
    create_lpar_lv_vhost: "{{ create_lpar_lv_vhost_line.split(':')[0] | trim }}"
  when: create_lpar_lv_vhost_line | length > 0

- name: Fail if no vhost adapter found
  ansible.builtin.fail:
    msg: >-
      No vhost adapter found for LPAR {{ create_lpar_lv_lpar_name }}
      (partition ID {{ create_lpar_lv_partition_id_hex }}).
      Verify the LPAR has a virtual SCSI adapter to VIOS {{ create_lpar_lv_vios_name }}.
  when: create_lpar_lv_vhost is not defined or create_lpar_lv_vhost | length == 0

# =============================================================================
# VTD-Name (max 15 Zeichen unter VIOS)
# =============================================================================

- name: Set VTD name for mapping (max 15 chars)
  ansible.builtin.set_fact:
    create_lpar_lv_vtd_name: "{{ create_lpar_lv_vtd_name | default((create_lpar_lv_lpar_name | truncate(11, True, '')) + '_vtd') }}"

# =============================================================================
# LV an vhost mappen (mkvdev)
# =============================================================================

- name: Map logical volume to LPAR via virtual SCSI
  ansible.builtin.raw: >-
    ioscli mkvdev -vdev {{ create_lpar_lv_volume_name }}
    -vadapter {{ create_lpar_lv_vhost }}
    -dev {{ create_lpar_lv_vtd_name }}
  delegate_to: "{{ create_lpar_lv_vios_host }}"
  remote_user: "{{ create_lpar_lv_vios_user }}"
  vars:
    ansible_connection: ssh
    ansible_ssh_pass: "{{ create_lpar_lv_vios_password }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  register: create_lpar_lv_mkvdev_result
  failed_when: >-
    create_lpar_lv_mkvdev_result.rc != 0 and
    'already exists' not in create_lpar_lv_mkvdev_result.stdout
  changed_when: create_lpar_lv_mkvdev_result.rc == 0

# =============================================================================
# Verifizierung & Ausgabe
# =============================================================================

- name: Verify virtual SCSI mapping
  ansible.builtin.raw: ioscli lsmap -vadapter {{ create_lpar_lv_vhost }} -fmt ':'
  delegate_to: "{{ create_lpar_lv_vios_host }}"
  remote_user: "{{ create_lpar_lv_vios_user }}"
  vars:
    ansible_connection: ssh
    ansible_ssh_pass: "{{ create_lpar_lv_vios_password }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  register: create_lpar_lv_lsmap_result
  changed_when: false

- name: Display VIOS storage mapping summary
  ansible.builtin.debug:
    msg: |
      create_lpar_lv – VIOS Storage:
        LPAR: {{ create_lpar_lv_lpar_name }}
        VIOS: {{ create_lpar_lv_vios_host }}
        Volume Group: {{ create_lpar_lv_volume_group }}
        Logical Volume: {{ create_lpar_lv_volume_name }} ({{ create_lpar_lv_disk_size_gb }}G)
        vHost Adapter: {{ create_lpar_lv_vhost }}
        VTD: {{ create_lpar_lv_vtd_name }}
        Mapping: {{ create_lpar_lv_lsmap_result.stdout }}
