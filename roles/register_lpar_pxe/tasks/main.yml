---
# yamllint disable rule:quoted-strings
# ansible-lint: variables naming uses pxe_register_ prefix by design
# =============================================================================
# REGISTER LPAR PXE – MAC extrahieren, TFTP, Kickstart, DHCP
# =============================================================================

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - pxe_register_hmc_host is defined and pxe_register_hmc_host | length > 0
      - pxe_register_lpar_name is defined and pxe_register_lpar_name | length > 0
      - pxe_register_managed_system is defined and pxe_register_managed_system | length > 0
      - pxe_register_network_name is defined and pxe_register_network_name | length > 0
      - pxe_register_host_ip is defined and pxe_register_host_ip | length > 0
      - pxe_register_hostname is defined and pxe_register_hostname | length > 0
      - pxe_register_host_gw is defined and pxe_register_host_gw | length > 0
      - pxe_register_host_netmask is defined and pxe_register_host_netmask | length > 0
      - pxe_register_host_subnet is defined and pxe_register_host_subnet | length > 0
      - pxe_register_dns_ip is defined and pxe_register_dns_ip | length > 0
      - pxe_register_hmc_password is defined and pxe_register_hmc_password | length > 0
      - pxe_register_dhcp_backend in ['isc', 'kea4']
    fail_msg: |
      Set: pxe_register_hmc_host, pxe_register_lpar_name, pxe_register_managed_system,
      pxe_register_network_name, pxe_register_host_ip, pxe_register_hostname,
      pxe_register_host_gw, pxe_register_host_netmask, pxe_register_host_subnet,
      pxe_register_dns_ip, pxe_register_hmc_password, pxe_register_dhcp_backend (isc or kea4)

# =============================================================================
# LPAR-Facts von HMC (für MAC)
# =============================================================================
- name: Get LPAR facts from HMC  # noqa: var-naming
  ibm.power_hmc.powervm_lpar_instance:
    hmc_host: "{{ pxe_register_hmc_host }}"
    hmc_auth:
      username: "{{ pxe_register_hmc_username | default(hmc_user, true) | default('hscroot') }}"
      password: "{{ pxe_register_hmc_password }}"
    system_name: "{{ pxe_register_managed_system }}"
    vm_name: "{{ pxe_register_lpar_name }}"
    advanced_info: true
    state: facts
  register: pxe_register_facts_output  # noqa: var-naming

- name: Find MAC address for network  # noqa: var-naming
  ansible.builtin.set_fact:
    pxe_register_mac_address: "{{ item.mac_address }}"
  loop: "{{ pxe_register_facts_output.partition_info.VirtualNetworkAdapters }}"
  when: item.virtual_network_name == pxe_register_network_name

- name: Fail if MAC not found
  ansible.builtin.fail:
    msg: "MAC not found for network {{ pxe_register_network_name }} on LPAR {{ pxe_register_lpar_name }}"
  when: pxe_register_mac_address is not defined or pxe_register_mac_address | length == 0

- name: MAC in colon format  # noqa: var-naming
  ansible.builtin.set_fact:
    pxe_register_hardware_ethernet: "{{ pxe_register_mac_address | regex_replace('(..)(..)(..)(..)(..)(..)', '\\1:\\2:\\3:\\4:\\5:\\6') }}"

- name: MAC in hyphen format (für grub.cfg-01-...)  # noqa: var-naming
  ansible.builtin.set_fact:
    pxe_register_address: "{{ pxe_register_mac_address | regex_replace('(..)(..)(..)(..)(..)(..)', '\\1-\\2-\\3-\\4-\\5-\\6') }}"

- name: Set dest_dir and ks_file  # noqa: var-naming
  ansible.builtin.set_fact:
    pxe_register_dest_dir: "{{ pxe_register_tftp_base_dir }}{{ pxe_register_mac_address }}"
    pxe_register_ks_file: "{{ pxe_register_distro | regex_replace('\\.', '') }}_{{ pxe_register_hardware_ethernet }}.ks"

# =============================================================================
# TFTP: bestehendes Verzeichnis entfernen, boot/ppc holen, GRUB
# =============================================================================
- name: Remove existing TFTP boot folder for this LPAR
  ansible.builtin.file:
    path: "{{ pxe_register_dest_dir }}"
    state: absent
  delegate_to: "{{ pxe_register_kickstart_host }}"

- name: Calculate cutdir for wget  # noqa: var-naming
  ansible.builtin.shell: set -o pipefail && echo "{{ pxe_register_repo_dir }}" | tr '/' '\n' | grep -v "^$" | wc -l
  register: pxe_register_cut_dir
  changed_when: false
  delegate_to: "{{ pxe_register_kickstart_host }}"

- name: Download boot/ from repo to TFTP path  # noqa: no-log-password command-instead-of-module
  ansible.builtin.shell: >-
    wget -r -nv --show-progress --reject="index.html*" --no-parent -nH
    --cut-dirs={{ pxe_register_cut_dir.stdout | int + 1 }}
    {{ pxe_register_ks_http_base }}/{{ pxe_register_repo_dir }}/boot/
    -P {{ pxe_register_dest_dir }}
  changed_when: false
  delegate_to: "{{ pxe_register_kickstart_host }}"

- name: Download ppc/ from repo to TFTP path  # noqa: command-instead-of-module
  ansible.builtin.shell: >-
    wget -r -nv --show-progress --reject="index.html*" --no-parent -nH
    --cut-dirs={{ pxe_register_cut_dir.stdout | int + 1 }}
    {{ pxe_register_ks_http_base }}/{{ pxe_register_repo_dir }}/ppc/
    -P {{ pxe_register_dest_dir }}
  changed_when: false
  delegate_to: "{{ pxe_register_kickstart_host }}"

- name: Create netboot directory (grub2-mknetdir)
  ansible.builtin.command: >
    grub2-mknetdir
    --net-directory={{ pxe_register_tftp_base_dir }}
    --subdir={{ pxe_register_mac_address }}/boot/grub/
  delegate_to: "{{ pxe_register_kickstart_host }}"
  changed_when: false

- name: Create grub.cfg for LPAR
  ansible.builtin.template:
    src: grub_conf.j2
    dest: "{{ pxe_register_dest_dir }}/boot/grub/grub.cfg"
    mode: "0777"
  delegate_to: "{{ pxe_register_kickstart_host }}"

- name: Copy grub.cfg to powerpc-ieee1275
  ansible.builtin.command: >
    cp "{{ pxe_register_dest_dir }}/boot/grub/grub.cfg"
    "{{ pxe_register_dest_dir }}/boot/grub/powerpc-ieee1275/grub.cfg-01-{{ pxe_register_address }}"
  delegate_to: "{{ pxe_register_kickstart_host }}"
  changed_when: false

# =============================================================================
# Kickstart-Datei auf Webserver
# =============================================================================
- name: Create kickstart file on repo server
  ansible.builtin.template:
    src: ks.j2
    dest: "{{ pxe_register_base_dir }}/{{ pxe_register_ks_file }}"
    mode: "0777"
  delegate_to: "{{ pxe_register_kickstart_host }}"

# =============================================================================
# DHCP: ISC oder KEA4
# =============================================================================
- name: Include DHCP config (ISC)
  ansible.builtin.include_tasks: setup_dhcp_isc.yml
  when: pxe_register_dhcp_backend == 'isc'

- name: Include DHCP config (KEA DHCP4)
  ansible.builtin.include_tasks: setup_dhcp_kea4.yml
  when: pxe_register_dhcp_backend == 'kea4'

- name: Summary
  ansible.builtin.debug:
    msg: |
      LPAR {{ pxe_register_lpar_name }} registered for PXE:
        MAC: {{ pxe_register_hardware_ethernet }}
        TFTP dest: {{ pxe_register_dest_dir }}
        Kickstart: {{ pxe_register_ks_file }}
        DHCP: {{ pxe_register_dhcp_backend }}
