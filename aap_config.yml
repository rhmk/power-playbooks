---
# This playbook is meant to postconfigure an AAP installation on OpenShift
#
# Prerequisites:
# - Install required collections: ansible-galaxy collection install -r requirements.yml
# - AAP instance running and accessible
#
# Authentication:
#   For SSO users (Red Hat SSO / Keycloak): generate a Personal Access Token in the
#   AAP UI (User -> Tokens -> Add, scope: write) and pass it via aap_token.
#
#   For local AAP users: pass aap_username + aap_password.
#
# Usage examples:
#   # With OAuth2 token (SSO users):
#   ansible-playbook aap_config.yml -e aap_hostname=aap.example.com -e aap_token=<token>
#
#   # With username/password (local users):
#   ansible-playbook aap_config.yml -e aap_hostname=aap.example.com -e aap_username=admin -e aap_password=<pass>


- name: AAP Post-Installation Configuration - configure AAP components
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    controller_postinstall_dir: './aap_config'
    controller_postinstall_ignore_files: './aap_config/ignore_files'
    aap_validate_certs: false

    # OAuth2 token authentication (for SSO/external auth users)
    aap_token: ""

    # Username/password authentication (for local AAP users only)
    aap_username: ""
    aap_password: ""

    aap_hostname: ""

  tasks:
    - name: Assert that authentication and hostname are configured
      ansible.builtin.assert:
        that:
          - aap_hostname | length > 0
          - (aap_token | length > 0) or (aap_username | length > 0 and aap_password | length > 0)
        fail_msg: |
          Invalid configuration:
          - aap_hostname must be set
          - Either aap_token (for SSO users) or aap_username + aap_password (for local users) must be provided

    - name: Include vars for automation controller
      ansible.builtin.include_vars:
        dir: '{{ controller_postinstall_dir }}'
        extensions:
          - yml
          - yaml
        ignore_files: '{{ controller_postinstall_ignore_files }}'
        ignore_unknown_extensions: true


    - name: Run AAP configuration dispatch role
      ansible.builtin.include_role:
        name: infra.aap_configuration.dispatch
